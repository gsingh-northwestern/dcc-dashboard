<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Disability Care Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
    
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Script 1: Firebase Setup (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, 
            collection, query, writeBatch, orderBy, updateDoc, addDoc, deleteDoc, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your personal Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyADj4tf65DjTOF29MW7xGO0OVRHs_cYDdg",
          authDomain: "dcc-nr-dashboard.firebaseapp.com",
          projectId: "dcc-nr-dashboard",
          storageBucket: "dcc-nr-dashboard.appspot.com",
          messagingSenderId: "648912013604",
          appId: "1:648912013604:web:f7824a262657ef8ca14bb1",
          measurementId: "G-P0VDLG0LCR"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            await signInAnonymously(getAuth(app));
            window.firebaseServices = { db, collection, doc, onSnapshot, query, orderBy, writeBatch, updateDoc, addDoc, deleteDoc, getDocs };
            window.dispatchEvent(new CustomEvent('firebase-ready'));
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }
    </script>

    <!-- Script 2: React Application -->
    <script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;
const { DragDropContext, Droppable, Draggable } = window.ReactBeautifulDnd;

const CATEGORIES = ["Physical Access", "Policy and Procedural Access", "Communication Access", "Provider Training Needs", "Disability Etiquette"];
const CATEGORY_COLORS = {
  "Physical Access": { text: "text-teal-700", border: "border-teal-600", tagBg: "bg-teal-100", tagText: "text-teal-800", ring: "focus:ring-teal-500" },
  "Policy and Procedural Access": { text: "text-indigo-700", border: "border-indigo-600", tagBg: "bg-indigo-100", tagText: "text-indigo-800", ring: "focus:ring-indigo-500" },
  "Communication Access": { text: "text-sky-700", border: "border-sky-600", tagBg: "bg-sky-100", tagText: "text-sky-800", ring: "focus:ring-sky-500" },
  "Provider Training Needs": { text: "text-amber-700", border: "border-amber-600", tagBg: "bg-amber-100", tagText: "text-amber-800", ring: "focus:ring-amber-500" },
  "Disability Etiquette": { text: "text-rose-700", border: "border-rose-600", tagBg: "bg-rose-100", tagText: "text-rose-800", ring: "focus:ring-rose-500" },
  "All": { text: "text-slate-700", border: "border-slate-600", tagBg: "bg-slate-100", tagText: "text-slate-800", ring: "focus:ring-slate-500" },
};
const TAB_ORDER = [...CATEGORIES, "All"];

const useAutosizeTextArea = (textAreaRef, value) => {
    useEffect(() => {
        if (textAreaRef && textAreaRef.current) {
            textAreaRef.current.style.height = "0px";
            textAreaRef.current.style.height = textAreaRef.current.scrollHeight + "px";
        }
    }, [textAreaRef, value]);
};

const TagInput = ({ existingTags, onAddTag, placeholder, colorClass }) => {
    const [inputValue, setInputValue] = useState('');
    const [showSuggestions, setShowSuggestions] = useState(false);
    const wrapperRef = useRef(null);
    const suggestions = (existingTags || []).filter(tag => tag.toLowerCase().includes(inputValue.toLowerCase()) && inputValue);
    useEffect(() => {
        function handleClickOutside(event) { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShowSuggestions(false); }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [wrapperRef]);
    const handleAdd = (tag) => { if (tag.trim() === '') return; onAddTag(tag.trim()); setInputValue(''); setShowSuggestions(false); }
    return (
        <div ref={wrapperRef} className="relative flex-grow">
            <div className="flex gap-2">
                <input type="text" value={inputValue} onChange={(e) => { setInputValue(e.target.value); if (!showSuggestions) setShowSuggestions(true); }} onFocus={() => setShowSuggestions(true)} onKeyPress={(e) => e.key === 'Enter' && handleAdd(inputValue)} placeholder={placeholder} className={`flex-grow p-2 border border-slate-300 rounded-md text-sm focus:ring-2 ${colorClass}`} />
                <button onClick={() => handleAdd(inputValue)} className="bg-slate-600 text-white px-4 py-2 rounded-md hover:bg-slate-700 text-sm font-semibold transition-colors">Add</button>
            </div>
            {showSuggestions && inputValue.length > 0 && (
                <ul className="absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                    {suggestions.map(tag => ( <li key={tag} onMouseDown={() => handleAdd(tag)} className="p-2 text-sm cursor-pointer hover:bg-slate-100">{tag}</li> ))}
                    {inputValue && !suggestions.find(s => s.toLowerCase() === inputValue.toLowerCase()) && <li onMouseDown={() => handleAdd(inputValue)} className="p-2 text-sm cursor-pointer italic text-slate-500 hover:bg-slate-100"> Add new: "{inputValue}" </li>}
                </ul>
            )}
        </div>
    );
};

function App() {
    const [firebase, setFirebase] = useState(null);
    const [recommendations, setRecommendations] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [activeTab, setActiveTab] = useState(TAB_ORDER[0]);
    const [filterSource, setFilterSource] = useState("");
    const [filterResource, setFilterResource] = useState("");
    const [isSettingsOpen, setIsSettingsOpen] = useState(false);
    const [allSourceTags, setAllSourceTags] = useState([]);
    const [allResourceTags, setAllResourceTags] = useState([]);
    const [confirmDelete, setConfirmDelete] = useState(null); 
    const debounceTimers = useRef({});
    
    useEffect(() => {
        const onFirebaseReady = () => setFirebase(window.firebaseServices);
        if (window.firebaseServices) onFirebaseReady();
        else window.addEventListener('firebase-ready', onFirebaseReady);
        return () => window.removeEventListener('firebase-ready', onFirebaseReady);
    }, []);

    useEffect(() => {
        if (!firebase) return;
        const { db, collection, query, orderBy, onSnapshot } = firebase;
        const recsCollectionRef = collection(db, "recommendations");
        const q = query(recsCollectionRef, orderBy("order", "asc"));
        
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const recsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setRecommendations(recsData);
            setAllSourceTags([...new Set(recsData.flatMap(r => r.sourceTags || []))].sort());
            setAllResourceTags([...new Set(recsData.flatMap(r => r.tags || []))].sort());
            setIsLoading(false);
        }, (error) => {
            console.error("Firestore snapshot error:", error);
            setIsLoading(false);
        });
        return () => unsubscribe();
    }, [firebase]);

    const updateDocInFirebase = async (recId, data) => { if (!firebase) return; await firebase.updateDoc(firebase.doc(firebase.db, "recommendations", recId), data); };
    const handleUpdateText = (recId, text, field) => { if (debounceTimers.current[recId + field]) clearTimeout(debounceTimers.current[recId + field]); setRecommendations(prev => prev.map(r => r.id === recId ? { ...r, [field]: text } : r)); debounceTimers.current[recId + field] = setTimeout(() => updateDocInFirebase(recId, { [field]: text }), 500); };
    const handleAddTag = useCallback((recId, tag, type) => { if (!tag || !firebase) return; const field = type === 'resource' ? 'tags' : 'sourceTags'; const rec = recommendations.find(r => r.id === recId); if (rec) updateDocInFirebase(recId, { [field]: [...new Set([...(rec[field] || []), tag])] }); }, [firebase, recommendations]);
    const handleRemoveTag = useCallback((recId, tagToRemove, type) => { if (!firebase) return; const field = type === 'resource' ? 'tags' : 'sourceTags'; const rec = recommendations.find(r => r.id === recId); if (rec) updateDocInFirebase(recId, { [field]: (rec[field] || []).filter(t => t !== tagToRemove) }); }, [firebase, recommendations]);
    const handleAddRecommendation = async () => { if (!firebase) return; const { db, collection, addDoc } = firebase; const newId = `custom-${Date.now()}`; await addDoc(collection(db, "recommendations"), { id: newId, category: activeTab === 'All' ? CATEGORIES[0] : activeTab, recommendation: "New Recommendation...", sources: ["Custom Source"], sourceTags: ["Custom"], tags: [], notes: "", order: recommendations.length }); };
    const onDragEnd = async (result) => {
        if (!result.destination || !firebase) return;
        const { db, doc, writeBatch } = firebase;
        const reorderedRecs = Array.from(recommendations);
        const [removed] = reorderedRecs.splice(result.source.index, 1);
        reorderedRecs.splice(result.destination.index, 0, removed);
        setRecommendations(reorderedRecs);
        const batch = writeBatch(db);
        reorderedRecs.forEach((rec, index) => batch.update(doc(db, "recommendations", rec.id), { order: index }));
        await batch.commit();
    };
    const handleMoveRecommendation = async (recId, newPosition) => { if (!firebase || !newPosition || isNaN(newPosition)) return; const targetIndex = parseInt(newPosition, 10) - 1; if (targetIndex < 0 || targetIndex >= recommendations.length) { alert("Invalid position number."); return; } const { db, doc, writeBatch } = firebase; const reorderedRecs = Array.from(recommendations); const [movedItem] = reorderedRecs.splice(reorderedRecs.findIndex(r => r.id === recId), 1); reorderedRecs.splice(targetIndex, 0, movedItem); setRecommendations(reorderedRecs); const batch = writeBatch(db); reorderedRecs.forEach((rec, index) => batch.update(doc(db, "recommendations", rec.id), { order: index })); await batch.commit(); };
    const handleDeleteRecommendation = async (recId) => { if (!firebase) return; await firebase.deleteDoc(firebase.doc(firebase.db, "recommendations", recId)); setConfirmDelete(null); };
    const handleDeleteTagFromRepo = (tagToDelete, type) => { if(!firebase) return; const { db, writeBatch, doc } = firebase; const batch = writeBatch(db); recommendations.forEach(rec => { const field = type === 'resource' ? 'tags' : 'sourceTags'; if((rec[field] || []).includes(tagToDelete)){ const updatedTags = rec[field].filter(t => t !== tagToDelete); batch.update(doc(db, "recommendations", rec.id), {[field]: updatedTags}); } }); batch.commit(); };
    const handleAddTagToRepo = (tag, type) => { if(!tag || tag.trim() === '') return; const setGlobalTags = type === 'resource' ? setAllResourceTags : setAllSourceTags; setGlobalTags(prev => [...new Set([...prev, tag.trim()])].sort()); };

    const filteredRecommendations = recommendations.filter(r => filterSource ? (r.sourceTags || []).includes(filterSource) : true).filter(r => filterResource ? (r.tags || []).includes(filterResource) : true);
    const currentRecommendations = activeTab === 'All' ? filteredRecommendations : filteredRecommendations.filter(r => r.category === activeTab);
    
    const RecommendationCard = ({ rec, index }) => {
        const [moveValue, setMoveValue] = useState("");
        const recTextAreaRef = useRef(null);
        const notesTextAreaRef = useRef(null);
        useAutosizeTextArea(recTextAreaRef, rec.recommendation);
        useAutosizeTextArea(notesTextAreaRef, rec.notes);
        const categoryColor = CATEGORY_COLORS[rec.category];

        return (
          <Draggable draggableId={rec.id} index={index}>
            {(provided, snapshot) => (
              <div ref={provided.innerRef} {...provided.draggableProps} className={`bg-white p-4 rounded-xl border border-slate-200 shadow-sm transition-shadow hover:shadow-lg flex gap-4 ${snapshot.isDragging ? 'shadow-2xl scale-105 transform -rotate-1' : ''}`}>
                  <div className="flex-shrink-0 flex flex-col items-center space-y-2 bg-slate-50 p-2 rounded-lg">
                     <div className="text-xl font-bold text-slate-500">{index + 1}.</div>
                     <div {...provided.dragHandleProps} className="p-2 cursor-grab text-slate-400 hover:text-slate-700" title="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg></div>
                     <button onClick={() => setConfirmDelete({id: rec.id, text: rec.recommendation})} className="p-2 text-slate-400 hover:text-red-600" title="Delete Recommendation"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                     <div className="flex flex-col items-center gap-1 pt-2 border-t border-slate-200">
                        <input type="number" value={moveValue} onChange={(e) => setMoveValue(e.target.value)} placeholder="#" className="w-16 p-1 border border-slate-300 rounded-md text-sm text-center"/>
                        <button onClick={() => {handleMoveRecommendation(rec.id, moveValue); setMoveValue('');}} className="bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300 text-xs font-semibold">Move</button>
                     </div>
                  </div>
                  <div className="flex-grow min-w-0 space-y-3">
                      {activeTab === 'All' && <div className={`text-xs font-bold uppercase tracking-wider ${categoryColor.text} mb-1`}>{rec.category}</div>}
                      <textarea ref={recTextAreaRef} value={rec.recommendation} onChange={(e) => handleUpdateText(rec.id, e.target.value, 'recommendation')} className="w-full text-base text-slate-800 bg-transparent border-none focus:ring-0 p-0 resize-none overflow-hidden" rows="1"/>
                       <details className="text-sm"><summary className="cursor-pointer font-semibold text-slate-600 hover:text-slate-800">View Full Citations</summary><ul className="list-disc list-inside text-xs text-slate-500 space-y-1 mt-2 pl-2">{rec.sources && rec.sources.map((source, i) => <li key={i}>{source}</li>)}</ul></details>
                      <div className="space-y-3">
                        <h5 className="font-semibold text-sm text-slate-600 -mb-1">Source Tags:</h5>
                         <div className="flex flex-wrap gap-2 min-h-[28px]">{rec.sourceTags && rec.sourceTags.map((tag, i) => ( <span key={i} className="flex items-center bg-slate-200 text-slate-700 text-xs font-medium px-2.5 py-1 rounded-md">{tag}<button onClick={() => handleRemoveTag(rec.id, tag, 'source')} className="ml-1.5 text-slate-500 hover:text-slate-800 font-bold">&times;</button></span>))}</div>
                         <TagInput existingTags={allSourceTags} onAddTag={(tag) => handleAddTag(rec.id, tag, 'source')} placeholder="Add source tag..." colorClass={CATEGORY_COLORS['All'].ring}/>
                      </div>
                      <div className="space-y-3">
                          <h5 className="font-semibold text-sm text-slate-600 -mb-1">Resources Required Tag:</h5>
                          <div className="flex flex-wrap gap-2 min-h-[28px]">{rec.tags && rec.tags.map(tag => ( <span key={tag} className={`flex items-center ${categoryColor.tagBg} ${categoryColor.tagText} text-xs font-semibold px-2.5 py-1 rounded-full`}>{tag}<button onClick={() => handleRemoveTag(rec.id, tag, 'resource')} className={`ml-1.5 ${categoryColor.text} hover:opacity-75 font-bold`}>&times;</button></span>))}</div>
                           <TagInput existingTags={allResourceTags} onAddTag={(tag) => handleAddTag(rec.id, tag, 'resource')} placeholder="e.g., Money, Staff, Training" colorClass={categoryColor.ring}/>
                      </div>
                      <div className="pt-3">
                          <h5 className="font-semibold text-sm text-slate-600 mb-2">Notes:</h5>
                           <div className="bg-yellow-50 border border-yellow-200 rounded-md p-2">
                            <textarea ref={notesTextAreaRef} value={rec.notes || ''} onChange={(e) => handleUpdateText(rec.id, e.target.value, 'notes')} placeholder="Add collaborative notes..." className="w-full text-sm text-yellow-900 bg-transparent border-none focus:ring-0 p-0 resize-none overflow-hidden placeholder-yellow-700/50" rows="1"/>
                           </div>
                        </div>
                  </div>
              </div>
            )}
          </Draggable>
        );
    };

    if (!firebase) return <div className="text-center p-12 text-xl text-slate-500 animate-pulse">Initializing Services...</div>;
    if (isLoading) return <div className="text-center p-12 text-xl text-slate-500 animate-pulse">Connecting to Database...</div>;
    
    return (
        <div className="bg-slate-50 min-h-screen font-sans text-slate-800">
             <div className="container mx-auto p-4 md:p-8">
                <div className="flex flex-col space-y-6">
                    <div className="flex justify-between items-center">
                        <h1 className="text-2xl font-bold text-slate-800">Collaborative Disability Care Dashboard</h1>
                        <button onClick={() => setIsSettingsOpen(true)} className="text-slate-600 hover:text-slate-800">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </button>
                    </div>
                    
                    <div className="flex space-x-2 overflow-x-auto pb-2">
                        {TAB_ORDER.map(tab => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap ${
                                    activeTab === tab
                                        ? `${CATEGORY_COLORS[tab].text} ${CATEGORY_COLORS[tab].border} border-2`
                                        : 'text-slate-500 hover:text-slate-700'
                                }`}
                            >
                                {tab}
                            </button>
                        ))}
                    </div>

                    <DragDropContext onDragEnd={onDragEnd}>
                        <Droppable droppableId="recommendations">
                            {(provided) => (
                                <div
                                    {...provided.droppableProps}
                                    ref={provided.innerRef}
                                    className="space-y-4"
                                >
                                    {currentRecommendations.map((rec, index) => (
                                        <RecommendationCard key={rec.id} rec={rec} index={index} />
                                    ))}
                                    {provided.placeholder}
                                </div>
                            )}
                        </Droppable>
                    </DragDropContext>

                    <button
                        onClick={handleAddRecommendation}
                        className="fixed bottom-8 right-8 bg-slate-800 text-white p-4 rounded-full shadow-lg hover:bg-slate-700 transition-colors"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
             </div>
        </div>
    );
}

// Add error boundary
try {
    ReactDOM.render(<App />, document.getElementById('root'));
} catch (error) {
    console.error('React initialization error:', error);
    document.getElementById('root').innerHTML = `
        <div class="text-center p-12">
            <h1 class="text-2xl font-bold text-red-600 mb-4">Error Loading Application</h1>
            <p class="text-slate-600">There was an error initializing the application. Please check the console for more details.</p>
        </div>
    `;
}
    </script>
</body>
</html>
