<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Disability Care Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
    <script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>
    <script src="https://unpkg.com/file-saver/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(4px); }
        
        /* Animations */
        .fade-enter { opacity: 0; }
        .fade-enter-active { opacity: 1; transition: opacity 200ms ease-in; }
        .fade-exit { opacity: 1; }
        .fade-exit-active { opacity: 0; transition: opacity 200ms ease-in; }
        
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .mobile-menu { display: none; }
            .mobile-menu.active { display: flex; }
        }
        
        /* Chart animations */
        .chart-container {
            transition: all 0.3s ease;
        }
        .chart-container:hover {
            transform: scale(1.02);
        }
        
        /* Stats card animations */
        .stats-card {
            transition: all 0.2s ease;
        }
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Dark mode styles */
        .dark {
            background-color: #1a1a1a;
            color: #e5e5e5;
        }
        
        .dark .bg-white {
            background-color: #2d2d2d;
        }
        
        .dark .text-slate-800 {
            color: #e5e5e5;
        }
        
        .dark .text-slate-600 {
            color: #a3a3a3;
        }
        
        .dark .border-slate-200 {
            border-color: #404040;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            .recommendation-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .page-break {
                page-break-before: always;
            }
        }
        
        /* Network graph styles */
        .node {
            cursor: pointer;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        
        .dark .link {
            stroke: #666;
        }
        
        /* Word cloud styles */
        .word-cloud {
            width: 100%;
            height: 400px;
        }
        
        /* Animation for undo/redo */
        .undo-redo-animation {
            animation: fadeInOut 0.3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Script 1: Firebase Setup (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, 
            collection, query, writeBatch, orderBy, updateDoc, addDoc, deleteDoc, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your personal Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyADj4tf65DjTOF29MW7xGO0OVRHs_cYDdg",
          authDomain: "dcc-nr-dashboard.firebaseapp.com",
          projectId: "dcc-nr-dashboard",
          storageBucket: "dcc-nr-dashboard.appspot.com",
          messagingSenderId: "648912013604",
          appId: "1:648912013604:web:f7824a262657ef8ca14bb1",
          measurementId: "G-P0VDLG0LCR"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            await signInAnonymously(getAuth(app));
            window.firebaseServices = { db, collection, doc, onSnapshot, query, orderBy, writeBatch, updateDoc, addDoc, deleteDoc, getDocs };
            window.dispatchEvent(new CustomEvent('firebase-ready'));
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }
    </script>

    <!-- Script 2: React Application -->
    <script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;
const { DragDropContext, Droppable, Draggable } = window.ReactBeautifulDnd;

const CATEGORIES = ["Physical Access", "Policy and Procedural Access", "Communication Access", "Provider Training Needs", "Disability Etiquette"];
const CATEGORY_COLORS = {
  "Physical Access": { text: "text-teal-700", border: "border-teal-600", tagBg: "bg-teal-100", tagText: "text-teal-800", ring: "focus:ring-teal-500" },
  "Policy and Procedural Access": { text: "text-indigo-700", border: "border-indigo-600", tagBg: "bg-indigo-100", tagText: "text-indigo-800", ring: "focus:ring-indigo-500" },
  "Communication Access": { text: "text-sky-700", border: "border-sky-600", tagBg: "bg-sky-100", tagText: "text-sky-800", ring: "focus:ring-sky-500" },
  "Provider Training Needs": { text: "text-amber-700", border: "border-amber-600", tagBg: "bg-amber-100", tagText: "text-amber-800", ring: "focus:ring-amber-500" },
  "Disability Etiquette": { text: "text-rose-700", border: "border-rose-600", tagBg: "bg-rose-100", tagText: "text-rose-800", ring: "focus:ring-rose-500" },
  "All": { text: "text-slate-700", border: "border-slate-600", tagBg: "bg-slate-100", tagText: "text-slate-800", ring: "focus:ring-slate-500" },
};
const TAB_ORDER = [...CATEGORIES, "All"];

const useAutosizeTextArea = (textAreaRef, value) => {
    useEffect(() => {
        if (textAreaRef && textAreaRef.current) {
            textAreaRef.current.style.height = "0px";
            textAreaRef.current.style.height = textAreaRef.current.scrollHeight + "px";
        }
    }, [textAreaRef, value]);
};

const TagInput = ({ existingTags, onAddTag, placeholder, colorClass }) => {
    const [inputValue, setInputValue] = useState('');
    const [showSuggestions, setShowSuggestions] = useState(false);
    const wrapperRef = useRef(null);
    const suggestions = (existingTags || []).filter(tag => tag.toLowerCase().includes(inputValue.toLowerCase()) && inputValue);
    useEffect(() => {
        function handleClickOutside(event) { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShowSuggestions(false); }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [wrapperRef]);
    const handleAdd = (tag) => { if (tag.trim() === '') return; onAddTag(tag.trim()); setInputValue(''); setShowSuggestions(false); }
    return (
        <div ref={wrapperRef} className="relative flex-grow">
            <div className="flex gap-2">
                <input type="text" value={inputValue} onChange={(e) => { setInputValue(e.target.value); if (!showSuggestions) setShowSuggestions(true); }} onFocus={() => setShowSuggestions(true)} onKeyPress={(e) => e.key === 'Enter' && handleAdd(inputValue)} placeholder={placeholder} className={`flex-grow p-2 border border-slate-300 rounded-md text-sm focus:ring-2 ${colorClass}`} />
                <button onClick={() => handleAdd(inputValue)} className="bg-slate-600 text-white px-4 py-2 rounded-md hover:bg-slate-700 text-sm font-semibold transition-colors">Add</button>
            </div>
            {showSuggestions && inputValue.length > 0 && (
                <ul className="absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                    {suggestions.map(tag => ( <li key={tag} onMouseDown={() => handleAdd(tag)} className="p-2 text-sm cursor-pointer hover:bg-slate-100">{tag}</li> ))}
                    {inputValue && !suggestions.find(s => s.toLowerCase() === inputValue.toLowerCase()) && <li onMouseDown={() => handleAdd(inputValue)} className="p-2 text-sm cursor-pointer italic text-slate-500 hover:bg-slate-100"> Add new: "{inputValue}" </li>}
                </ul>
            )}
        </div>
    );
};

function App() {
    const [firebase, setFirebase] = useState(null);
    const [recommendations, setRecommendations] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [activeTab, setActiveTab] = useState(TAB_ORDER[0]);
    const [filterSource, setFilterSource] = useState("");
    const [filterResource, setFilterResource] = useState("");
    const [isSettingsOpen, setIsSettingsOpen] = useState(false);
    const [allSourceTags, setAllSourceTags] = useState([]);
    const [allResourceTags, setAllResourceTags] = useState([]);
    const [confirmDelete, setConfirmDelete] = useState(null);
    const [searchQuery, setSearchQuery] = useState("");
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
    const [showKeyboardShortcuts, setShowKeyboardShortcuts] = useState(false);
    const [showStats, setShowStats] = useState(false);
    const [statsData, setStatsData] = useState(null);
    const debounceTimers = useRef({});
    const [isDarkMode, setIsDarkMode] = useState(false);
    const [history, setHistory] = useState([]);
    const [historyIndex, setHistoryIndex] = useState(-1);
    const [showPrintView, setShowPrintView] = useState(false);
    const [libraryErrors, setLibraryErrors] = useState([]);
    
    // Initialize dark mode
    useEffect(() => {
        const darkMode = localStorage.getItem('darkMode') === 'true';
        setIsDarkMode(darkMode);
        if (darkMode) {
            document.documentElement.classList.add('dark');
        }
    }, []);
    
    // Toggle dark mode
    const toggleDarkMode = () => {
        const newMode = !isDarkMode;
        setIsDarkMode(newMode);
        localStorage.setItem('darkMode', newMode.toString());
        document.documentElement.classList.toggle('dark');
    };
    
    // History management
    const addToHistory = (action) => {
        const newHistory = history.slice(0, historyIndex + 1);
        newHistory.push(action);
        setHistory(newHistory);
        setHistoryIndex(newHistory.length - 1);
    };
    
    const undo = () => {
        if (historyIndex > 0) {
            setHistoryIndex(historyIndex - 1);
            const action = history[historyIndex - 1];
            // Apply undo action
            if (action.type === 'update') {
                updateRecommendation(action.id, action.oldValue);
            } else if (action.type === 'delete') {
                addRecommendation(action.data);
            }
        }
    };
    
    const redo = () => {
        if (historyIndex < history.length - 1) {
            setHistoryIndex(historyIndex + 1);
            const action = history[historyIndex + 1];
            // Apply redo action
            if (action.type === 'update') {
                updateRecommendation(action.id, action.newValue);
            } else if (action.type === 'delete') {
                deleteRecommendation(action.id);
            }
        }
    };
    
    // Enhanced keyboard shortcuts
    useEffect(() => {
        hotkeys('ctrl+z, cmd+z', (e) => {
            e.preventDefault();
            undo();
        });
        
        hotkeys('ctrl+shift+z, cmd+shift+z', (e) => {
            e.preventDefault();
            redo();
        });
        
        hotkeys('ctrl+d, cmd+d', (e) => {
            e.preventDefault();
            toggleDarkMode();
        });
        
        hotkeys('ctrl+p, cmd+p', (e) => {
            e.preventDefault();
            setShowPrintView(true);
        });
        
        hotkeys('ctrl+s, cmd+s', (e) => {
            e.preventDefault();
            exportToExcel();
        });
        
        return () => {
            hotkeys.unbind('ctrl+z, cmd+z');
            hotkeys.unbind('ctrl+shift+z, cmd+shift+z');
            hotkeys.unbind('ctrl+d, cmd+d');
            hotkeys.unbind('ctrl+p, cmd+p');
            hotkeys.unbind('ctrl+s, cmd+s');
        };
    }, []);
    
    // Tag correlation analysis
    const calculateTagCorrelations = () => {
        const correlations = {};
        recommendations.forEach(rec => {
            const tags = [...(rec.tags || []), ...(rec.sourceTags || [])];
            tags.forEach(tag1 => {
                tags.forEach(tag2 => {
                    if (tag1 !== tag2) {
                        if (!correlations[tag1]) correlations[tag1] = {};
                        if (!correlations[tag1][tag2]) correlations[tag1][tag2] = 0;
                        correlations[tag1][tag2]++;
                    }
                });
            });
        });
        return correlations;
    };
    
    // Generate word cloud
    const generateWordCloud = () => {
        const words = recommendations.reduce((acc, rec) => {
            const text = `${rec.text} ${rec.notes || ''}`.toLowerCase();
            const words = text.match(/\b\w+\b/g) || [];
            words.forEach(word => {
                if (word.length > 3) {
                    acc[word] = (acc[word] || 0) + 1;
                }
            });
            return acc;
        }, {});
        
        return Object.entries(words)
            .map(([text, size]) => ({ text, size }))
            .sort((a, b) => b.size - a.size)
            .slice(0, 100);
    };
    
    // Export to Excel
    const exportToExcel = () => {
        const wb = XLSX.utils.book_new();
        
        // Recommendations sheet
        const recommendationsData = recommendations.map(rec => ({
            ID: rec.id,
            Text: rec.text,
            Category: rec.category,
            ResourceTags: (rec.tags || []).join(', '),
            SourceTags: (rec.sourceTags || []).join(', '),
            Notes: rec.notes || ''
        }));
        const ws = XLSX.utils.json_to_sheet(recommendationsData);
        XLSX.utils.book_append_sheet(wb, ws, 'Recommendations');
        
        // Statistics sheet
        const statsData = [
            ['Total Recommendations', recommendations.length],
            ['Average Tags per Recommendation', statsData?.averageTagsPerRecommendation.toFixed(1)],
            ['Recommendations with Notes', statsData?.recommendationsWithNotes]
        ];
        const statsWs = XLSX.utils.aoa_to_sheet(statsData);
        XLSX.utils.book_append_sheet(wb, statsWs, 'Statistics');
        
        // Save file
        XLSX.writeFile(wb, 'disability_care_dashboard.xlsx');
    };
    
    // Export to PDF
    const exportToPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(20);
        doc.text('Disability Care Dashboard Report', 20, 20);
        
        // Add statistics
        doc.setFontSize(12);
        doc.text(`Total Recommendations: ${recommendations.length}`, 20, 40);
        doc.text(`Average Tags per Recommendation: ${statsData?.averageTagsPerRecommendation.toFixed(1)}`, 20, 50);
        doc.text(`Recommendations with Notes: ${statsData?.recommendationsWithNotes}`, 20, 60);
        
        // Add recommendations
        let y = 80;
        recommendations.forEach((rec, index) => {
            if (y > 250) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(14);
            doc.text(`Recommendation ${index + 1}`, 20, y);
            y += 10;
            
            doc.setFontSize(12);
            doc.text(rec.text, 20, y, { maxWidth: 170 });
            y += 20;
            
            if (rec.notes) {
                doc.setFontSize(10);
                doc.text(`Notes: ${rec.notes}`, 20, y, { maxWidth: 170 });
                y += 15;
            }
            
            y += 10;
        });
        
        doc.save('disability_care_dashboard.pdf');
    };
    
    // Export data
    const handleExportData = () => {
        const data = {
            recommendations,
            sourceTags: allSourceTags,
            resourceTags: allResourceTags,
            exportDate: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        saveAs(blob, `dashboard-export-${new Date().toISOString().split('T')[0]}.json`);
    };

    // Import data
    const handleImportData = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (!data.recommendations || !Array.isArray(data.recommendations)) {
                throw new Error('Invalid data format');
            }

            // Clear existing data
            const { db, writeBatch, doc, deleteDoc, collection, addDoc } = firebase;
            const batch = writeBatch(db);
            
            // Delete existing recommendations
            const existingDocs = await firebase.getDocs(collection(db, "recommendations"));
            existingDocs.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            // Add new recommendations
            data.recommendations.forEach(rec => {
                const newDocRef = doc(collection(db, "recommendations"));
                batch.set(newDocRef, rec);
            });
            
            await batch.commit();
            alert('Data imported successfully!');
        } catch (error) {
            console.error('Import error:', error);
            alert('Error importing data. Please check the file format.');
        }
    };

    // Search functionality
    const filteredRecommendations = recommendations
        .filter(r => filterSource ? (r.sourceTags || []).includes(filterSource) : true)
        .filter(r => filterResource ? (r.tags || []).includes(filterResource) : true)
        .filter(r => {
            if (!searchQuery) return true;
            const query = searchQuery.toLowerCase();
            return (
                r.recommendation.toLowerCase().includes(query) ||
                (r.notes || '').toLowerCase().includes(query) ||
                (r.sourceTags || []).some(tag => tag.toLowerCase().includes(query)) ||
                (r.tags || []).some(tag => tag.toLowerCase().includes(query))
            );
        });

    useEffect(() => {
        const onFirebaseReady = () => setFirebase(window.firebaseServices);
        if (window.firebaseServices) onFirebaseReady();
        else window.addEventListener('firebase-ready', onFirebaseReady);
        return () => window.removeEventListener('firebase-ready', onFirebaseReady);
    }, []);

    useEffect(() => {
        if (!firebase) return;
        const { db, collection, query, orderBy, onSnapshot } = firebase;
        const recsCollectionRef = collection(db, "recommendations");
        const q = query(recsCollectionRef, orderBy("order", "asc"));
        
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const recsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setRecommendations(recsData);
            setAllSourceTags([...new Set(recsData.flatMap(r => r.sourceTags || []))].sort());
            setAllResourceTags([...new Set(recsData.flatMap(r => r.tags || []))].sort());
            setIsLoading(false);
        }, (error) => {
            console.error("Firestore snapshot error:", error);
            setIsLoading(false);
        });
        return () => unsubscribe();
    }, [firebase]);

    const updateDocInFirebase = async (recId, data) => { if (!firebase) return; await firebase.updateDoc(firebase.doc(firebase.db, "recommendations", recId), data); };
    const handleUpdateText = (recId, text, field) => { if (debounceTimers.current[recId + field]) clearTimeout(debounceTimers.current[recId + field]); setRecommendations(prev => prev.map(r => r.id === recId ? { ...r, [field]: text } : r)); debounceTimers.current[recId + field] = setTimeout(() => updateDocInFirebase(recId, { [field]: text }), 500); };
    const handleAddTag = useCallback((recId, tag, type) => { if (!tag || !firebase) return; const field = type === 'resource' ? 'tags' : 'sourceTags'; const rec = recommendations.find(r => r.id === recId); if (rec) updateDocInFirebase(recId, { [field]: [...new Set([...(rec[field] || []), tag])] }); }, [firebase, recommendations]);
    const handleRemoveTag = useCallback((recId, tagToRemove, type) => { if (!firebase) return; const field = type === 'resource' ? 'tags' : 'sourceTags'; const rec = recommendations.find(r => r.id === recId); if (rec) updateDocInFirebase(recId, { [field]: (rec[field] || []).filter(t => t !== tagToRemove) }); }, [firebase, recommendations]);
    const handleAddRecommendation = async () => { if (!firebase) return; const { db, collection, addDoc } = firebase; const newId = `custom-${Date.now()}`; await addDoc(collection(db, "recommendations"), { id: newId, category: activeTab === 'All' ? CATEGORIES[0] : activeTab, recommendation: "New Recommendation...", sources: ["Custom Source"], sourceTags: ["Custom"], tags: [], notes: "", order: recommendations.length }); };
    const onDragEnd = async (result) => {
        if (!result.destination || !firebase) return;
        const { db, doc, writeBatch } = firebase;
        const reorderedRecs = Array.from(recommendations);
        const [removed] = reorderedRecs.splice(result.source.index, 1);
        reorderedRecs.splice(result.destination.index, 0, removed);
        setRecommendations(reorderedRecs);
        const batch = writeBatch(db);
        reorderedRecs.forEach((rec, index) => batch.update(doc(db, "recommendations", rec.id), { order: index }));
        await batch.commit();
    };
    const handleMoveRecommendation = async (recId, newPosition) => { if (!firebase || !newPosition || isNaN(newPosition)) return; const targetIndex = parseInt(newPosition, 10) - 1; if (targetIndex < 0 || targetIndex >= recommendations.length) { alert("Invalid position number."); return; } const { db, doc, writeBatch } = firebase; const reorderedRecs = Array.from(recommendations); const [movedItem] = reorderedRecs.splice(reorderedRecs.findIndex(r => r.id === recId), 1); reorderedRecs.splice(targetIndex, 0, movedItem); setRecommendations(reorderedRecs); const batch = writeBatch(db); reorderedRecs.forEach((rec, index) => batch.update(doc(db, "recommendations", rec.id), { order: index })); await batch.commit(); };
    const handleDeleteRecommendation = async (recId) => { if (!firebase) return; await firebase.deleteDoc(firebase.doc(firebase.db, "recommendations", recId)); setConfirmDelete(null); };
    const handleDeleteTagFromRepo = (tagToDelete, type) => { if(!firebase) return; const { db, writeBatch, doc } = firebase; const batch = writeBatch(db); recommendations.forEach(rec => { const field = type === 'resource' ? 'tags' : 'sourceTags'; if((rec[field] || []).includes(tagToDelete)){ const updatedTags = rec[field].filter(t => t !== tagToDelete); batch.update(doc(db, "recommendations", rec.id), {[field]: updatedTags}); } }); batch.commit(); };
    const handleAddTagToRepo = (tag, type) => { if(!tag || tag.trim() === '') return; const setGlobalTags = type === 'resource' ? setAllResourceTags : setAllSourceTags; setGlobalTags(prev => [...new Set([...prev, tag.trim()])].sort()); };

    const currentRecommendations = activeTab === 'All' ? filteredRecommendations : filteredRecommendations.filter(r => r.category === activeTab);
    
    const RecommendationCard = ({ rec, index }) => {
        const [moveValue, setMoveValue] = useState("");
        const recTextAreaRef = useRef(null);
        const notesTextAreaRef = useRef(null);
        useAutosizeTextArea(recTextAreaRef, rec.recommendation);
        useAutosizeTextArea(notesTextAreaRef, rec.notes);
        const categoryColor = CATEGORY_COLORS[rec.category];

        return (
          <Draggable draggableId={rec.id} index={index}>
            {(provided, snapshot) => (
              <div ref={provided.innerRef} {...provided.draggableProps} className={`bg-white p-4 rounded-xl border border-slate-200 shadow-sm transition-shadow hover:shadow-lg flex gap-4 ${snapshot.isDragging ? 'shadow-2xl scale-105 transform -rotate-1' : ''}`}>
                  <div className="flex-shrink-0 flex flex-col items-center space-y-2 bg-slate-50 p-2 rounded-lg">
                     <div className="text-xl font-bold text-slate-500">{index + 1}</div>
                     <div {...provided.dragHandleProps} className="p-2 cursor-grab text-slate-400 hover:text-slate-700" title="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg></div>
                     <button onClick={() => setConfirmDelete({id: rec.id, text: rec.recommendation})} className="p-2 text-slate-400 hover:text-red-600" title="Delete Recommendation"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                     <div className="flex flex-col items-center gap-1 pt-2 border-t border-slate-200">
                        <input type="number" value={moveValue} onChange={(e) => setMoveValue(e.target.value)} placeholder="#" className="w-16 p-1 border border-slate-300 rounded-md text-sm text-center"/>
                        <button onClick={() => {handleMoveRecommendation(rec.id, moveValue); setMoveValue('');}} className="w-16 bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300 text-xs font-semibold">Move</button>
                     </div>
                  </div>
                  <div className="flex-grow min-w-0 space-y-3">
                      {activeTab === 'All' && <div className={`text-xs font-bold uppercase tracking-wider ${categoryColor.text} mb-1`}>{rec.category}</div>}
                      <textarea ref={recTextAreaRef} value={rec.recommendation} onChange={(e) => handleUpdateText(rec.id, e.target.value, 'recommendation')} className="w-full text-base text-slate-800 bg-transparent border-none focus:ring-0 p-0 resize-none overflow-hidden" rows="1"/>
                       <details className="text-sm"><summary className="cursor-pointer font-semibold text-slate-600 hover:text-slate-800">View Full Citations</summary><ul className="list-disc list-inside text-xs text-slate-500 space-y-1 mt-2 pl-2">{rec.sources && rec.sources.map((source, i) => <li key={i}>{source}</li>)}</ul></details>
                      <div className="space-y-3">
                        <h5 className="font-semibold text-sm text-slate-600 -mb-1">Source Tags:</h5>
                         <div className="flex flex-wrap gap-2 min-h-[28px]">{rec.sourceTags && rec.sourceTags.map((tag, i) => ( <span key={i} className="flex items-center bg-slate-200 text-slate-700 text-xs font-medium px-2.5 py-1 rounded-md">{tag}<button onClick={() => handleRemoveTag(rec.id, tag, 'source')} className="ml-1.5 text-slate-500 hover:text-slate-800 font-bold">&times;</button></span>))}</div>
                         <TagInput existingTags={allSourceTags} onAddTag={(tag) => handleAddTag(rec.id, tag, 'source')} placeholder="Add source tag..." colorClass={CATEGORY_COLORS['All'].ring}/>
                      </div>
                      <div className="space-y-3">
                          <h5 className="font-semibold text-sm text-slate-600 mb-2">Resources Required Tag:</h5>
                          <div className="flex flex-wrap gap-2 min-h-[28px]">{rec.tags && rec.tags.map(tag => ( <span key={tag} className={`flex items-center ${categoryColor.tagBg} ${categoryColor.tagText} text-xs font-semibold px-2.5 py-1 rounded-full`}>{tag}<button onClick={() => handleRemoveTag(rec.id, tag, 'resource')} className={`ml-1.5 ${categoryColor.text} hover:opacity-75 font-bold`}>&times;</button></span>))}</div>
                           <TagInput existingTags={allResourceTags} onAddTag={(tag) => handleAddTag(rec.id, tag, 'resource')} placeholder="e.g., Money, Staff, Training" colorClass={categoryColor.ring}/>
                      </div>
                      <div className="pt-3">
                          <h5 className="font-semibold text-sm text-slate-600 mb-2">Notes:</h5>
                           <div className="bg-yellow-50 border border-yellow-200 rounded-md p-2">
                            <textarea ref={notesTextAreaRef} value={rec.notes || ''} onChange={(e) => handleUpdateText(rec.id, e.target.value, 'notes')} placeholder="Add collaborative notes..." className="w-full text-sm text-yellow-900 bg-transparent border-none focus:ring-0 p-0 resize-none overflow-hidden placeholder-yellow-700/50" rows="1"/>
                           </div>
                        </div>
                  </div>
              </div>
            )}
          </Draggable>
        );
    };

    // Calculate statistics
    useEffect(() => {
        if (!recommendations.length) return;
        
        const stats = {
            totalRecommendations: recommendations.length,
            categoryDistribution: CATEGORIES.reduce((acc, category) => {
                acc[category] = recommendations.filter(r => r.category === category).length;
                return acc;
            }, {}),
            resourceTagDistribution: allResourceTags.reduce((acc, tag) => {
                acc[tag] = recommendations.filter(r => (r.tags || []).includes(tag)).length;
                return acc;
            }, {}),
            sourceTagDistribution: allSourceTags.reduce((acc, tag) => {
                acc[tag] = recommendations.filter(r => (r.sourceTags || []).includes(tag)).length;
                return acc;
            }, {}),
            averageTagsPerRecommendation: recommendations.reduce((acc, r) => {
                return acc + ((r.tags || []).length + (r.sourceTags || []).length);
            }, 0) / recommendations.length,
            recommendationsWithNotes: recommendations.filter(r => r.notes && r.notes.trim()).length
        };
        
        setStatsData(stats);
    }, [recommendations, allResourceTags, allSourceTags]);

    // Initialize charts
    useEffect(() => {
        if (!statsData || !showStats) return;
        
        // Category Distribution Chart
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: CATEGORIES,
                    datasets: [{
                        data: CATEGORIES.map(cat => statsData.categoryDistribution[cat]),
                        backgroundColor: CATEGORIES.map(cat => {
                            const color = CATEGORY_COLORS[cat];
                            return `rgb(${parseInt(color.text.slice(5, -3))}, ${parseInt(color.text.slice(5, -3))}, ${parseInt(color.text.slice(5, -3))})`;
                        })
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Resource Tags Chart
        const resourceCtx = document.getElementById('resourceChart');
        if (resourceCtx) {
            const sortedTags = Object.entries(statsData.resourceTagDistribution)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            new Chart(resourceCtx, {
                type: 'bar',
                data: {
                    labels: sortedTags.map(([tag]) => tag),
                    datasets: [{
                        label: 'Number of Recommendations',
                        data: sortedTags.map(([,count]) => count),
                        backgroundColor: 'rgba(51, 65, 85, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    }, [statsData, showStats]);

    // Check library initialization
    useEffect(() => {
        const errors = [];
        
        // Check Chart.js
        if (typeof Chart === 'undefined') {
            errors.push('Chart.js failed to load');
        }
        
        // Check D3
        if (typeof d3 === 'undefined') {
            errors.push('D3.js failed to load');
        }
        
        // Check WordCloud
        if (typeof WordCloud === 'undefined') {
            errors.push('WordCloud failed to load');
        }
        
        // Check jsPDF
        if (typeof window.jspdf === 'undefined') {
            errors.push('jsPDF failed to load');
        }
        
        // Check XLSX
        if (typeof XLSX === 'undefined') {
            errors.push('XLSX failed to load');
        }
        
        setLibraryErrors(errors);
        
        if (errors.length > 0) {
            console.error('Library loading errors:', errors);
        }
    }, []);
    
    // Initialize word cloud
    useEffect(() => {
        if (!showStats || !statsData || libraryErrors.length > 0) return;
        
        try {
            const words = generateWordCloud();
            const container = document.getElementById('wordCloud');
            if (container) {
                WordCloud(container, {
                    list: words,
                    gridSize: 16,
                    weightFactor: 10,
                    fontFamily: 'sans-serif',
                    color: isDarkMode ? '#e5e5e5' : '#1e293b',
                    hover: window.drawBox,
                    click: function(item) {
                        console.log(item[0], item[1]);
                    }
                });
            }
        } catch (error) {
            console.error('Word cloud initialization error:', error);
        }
    }, [showStats, statsData, isDarkMode, libraryErrors]);
    
    // Initialize network graph
    useEffect(() => {
        if (!showStats || !statsData || libraryErrors.length > 0) return;
        
        try {
            const container = document.getElementById('networkGraph');
            if (!container) return;
            
            // Clear previous graph
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const correlations = calculateTagCorrelations();
            const nodes = Object.keys(correlations).map(tag => ({ id: tag }));
            const links = [];
            
            Object.entries(correlations).forEach(([tag1, corrs]) => {
                Object.entries(corrs).forEach(([tag2, weight]) => {
                    if (weight > 0) {
                        links.push({
                            source: tag1,
                            target: tag2,
                            value: weight
                        });
                    }
                });
            });
            
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));
            
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.sqrt(d.value));
            
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('class', 'node')
                .attr('r', 5)
                .attr('fill', isDarkMode ? '#e5e5e5' : '#1e293b')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .enter()
                .append('text')
                .text(d => d.id)
                .attr('font-size', 10)
                .attr('dx', 12)
                .attr('dy', 4)
                .attr('fill', isDarkMode ? '#e5e5e5' : '#1e293b');
            
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        } catch (error) {
            console.error('Network graph initialization error:', error);
        }
    }, [showStats, statsData, isDarkMode, libraryErrors]);
    
    // Show error message if libraries failed to load
    if (libraryErrors.length > 0) {
        return (
            <div className="fixed inset-0 bg-red-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
                    <h2 className="text-xl font-bold text-red-600 mb-4">Error Loading Required Libraries</h2>
                    <ul className="list-disc list-inside space-y-2">
                        {libraryErrors.map((error, index) => (
                            <li key={index} className="text-red-500">{error}</li>
                        ))}
                    </ul>
                    <p className="mt-4 text-slate-600">
                        Please refresh the page or check your internet connection. If the problem persists, contact support.
                    </p>
                </div>
            </div>
        );
    }

    if (!firebase) return <div className="text-center p-12 text-xl text-slate-500 animate-pulse">Initializing Services...</div>;
    if (isLoading) return <div className="text-center p-12 text-xl text-slate-500 animate-pulse">Connecting to Database...</div>;
    
    return (
        <div className={`bg-slate-50 min-h-screen font-sans ${isDarkMode ? 'dark' : ''}`}>
            {/* Floating Navigation Bar */}
            <div className="fixed top-0 left-0 right-0 bg-white shadow-md z-50">
                <div className="container mx-auto px-4 py-3">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center space-x-4">
                            <h1 className="text-xl font-bold text-slate-800">Collaborative Disability Care Dashboard</h1>
                            <button
                                onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                                className="md:hidden p-2 text-slate-600 hover:text-slate-800"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div className={`md:flex items-center space-x-4 ${isMobileMenuOpen ? 'mobile-menu active' : 'mobile-menu'}`}>
                            {/* Search Bar */}
                            <div className="relative">
                                <input
                                    id="searchInput"
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Search recommendations..."
                                    className="w-64 px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-slate-500 focus:border-transparent"
                                />
                                {searchQuery && (
                                    <button
                                        onClick={() => setSearchQuery('')}
                                        className="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                )}
                            </div>

                            {/* Source Tags Dropdown */}
                            <div className="relative group">
                                <button className="flex items-center space-x-2 px-4 py-2 text-slate-600 hover:text-slate-800 bg-slate-100 rounded-lg">
                                    <span>Source Tags</span>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"/></svg>
                                </button>
                                <div className="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-slate-200 hidden group-hover:block">
                                    <div className="p-3">
                                        <div className="flex flex-wrap gap-2">
                                            {allSourceTags.map(tag => (
                                                <button
                                                    key={tag}
                                                    onClick={() => setFilterSource(filterSource === tag ? "" : tag)}
                                                    className={`px-3 py-1 rounded-full text-sm ${
                                                        filterSource === tag
                                                            ? 'bg-slate-800 text-white'
                                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                                    }`}
                                                >
                                                    {tag}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Resource Tags Dropdown */}
                            <div className="relative group">
                                <button className="flex items-center space-x-2 px-4 py-2 text-slate-600 hover:text-slate-800 bg-slate-100 rounded-lg">
                                    <span>Resource Tags</span>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"/></svg>
                                </button>
                                <div className="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-slate-200 hidden group-hover:block">
                                    <div className="p-3">
                                        <div className="flex flex-wrap gap-2">
                                            {allResourceTags.map(tag => (
                                                <button
                                                    key={tag}
                                                    onClick={() => setFilterResource(filterResource === tag ? "" : tag)}
                                                    className={`px-3 py-1 rounded-full text-sm ${
                                                        filterResource === tag
                                                            ? 'bg-slate-800 text-white'
                                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                                    }`}
                                                >
                                                    {tag}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Add Recommendation Button */}
                            <button
                                onClick={handleAddRecommendation}
                                className="flex items-center space-x-2 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"/></svg>
                                <span>Add Recommendation</span>
                            </button>

                            {/* Settings Button */}
                            <button
                                onClick={() => setIsSettingsOpen(true)}
                                className="p-2 text-slate-600 hover:text-slate-800"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            </button>

                            {/* Data Management */}
                            <div className="relative group">
                                <button className="flex items-center space-x-2 px-4 py-2 text-slate-600 hover:text-slate-800 bg-slate-100 rounded-lg">
                                    <span>Data</span>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>
                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 hidden group-hover:block">
                                    <div className="p-2 space-y-2">
                                        <button
                                            onClick={handleExportData}
                                            className="w-full px-4 py-2 text-left text-sm text-slate-600 hover:bg-slate-100 rounded-md"
                                        >
                                            Export Data
                                        </button>
                                        <label className="w-full px-4 py-2 text-left text-sm text-slate-600 hover:bg-slate-100 rounded-md cursor-pointer">
                                            Import Data
                                            <input
                                                type="file"
                                                accept=".json"
                                                onChange={handleImportData}
                                                className="hidden"
                                            />
                                        </label>
                                    </div>
                                </div>
                            </div>

                            {/* Keyboard Shortcuts Button */}
                            <button
                                onClick={() => setShowKeyboardShortcuts(true)}
                                className="p-2 text-slate-600 hover:text-slate-800"
                                title="Keyboard Shortcuts (Ctrl + /)"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* Main Content with top padding for fixed nav */}
            <div className="container mx-auto p-4 md:p-8 pt-20">
                <div className="flex flex-col space-y-6">
                    <div className="flex space-x-2 overflow-x-auto pb-2">
                        {TAB_ORDER.map(tab => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap ${
                                    activeTab === tab
                                        ? `${CATEGORY_COLORS[tab].text} ${CATEGORY_COLORS[tab].border} border-2`
                                        : 'text-slate-500 hover:text-slate-700'
                                }`}
                            >
                                {tab}
                            </button>
                        ))}
                    </div>

                    <DragDropContext onDragEnd={onDragEnd}>
                        <Droppable droppableId="recommendations">
                            {(provided) => (
                                <div
                                    {...provided.droppableProps}
                                    ref={provided.innerRef}
                                    className="space-y-4"
                                >
                                    {currentRecommendations.map((rec, index) => (
                                        <RecommendationCard key={rec.id} rec={rec} index={index} />
                                    ))}
                                    {provided.placeholder}
                                </div>
                            )}
                        </Droppable>
                    </DragDropContext>
                </div>
            </div>

            {/* Stats Button */}
            <button
                onClick={() => setShowStats(true)}
                className="fixed bottom-8 left-8 bg-slate-800 text-white p-4 rounded-full shadow-lg hover:bg-slate-700 transition-colors"
                title="View Statistics"
            >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
            </button>

            {/* Stats Modal */}
            {showStats && statsData && (
                <div className="modal-overlay">
                    <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-6xl w-full mx-4 scale-in">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800">Dashboard Statistics</h2>
                            <button
                                onClick={() => setShowStats(false)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            <div className="stats-card bg-white p-4 rounded-lg border border-slate-200">
                                <h3 className="text-sm font-medium text-slate-500">Total Recommendations</h3>
                                <p className="text-2xl font-bold text-slate-800">{statsData.totalRecommendations}</p>
                            </div>
                            <div className="stats-card bg-white p-4 rounded-lg border border-slate-200">
                                <h3 className="text-sm font-medium text-slate-500">Average Tags per Recommendation</h3>
                                <p className="text-2xl font-bold text-slate-800">{statsData.averageTagsPerRecommendation.toFixed(1)}</p>
                            </div>
                            <div className="stats-card bg-white p-4 rounded-lg border border-slate-200">
                                <h3 className="text-sm font-medium text-slate-500">Recommendations with Notes</h3>
                                <p className="text-2xl font-bold text-slate-800">{statsData.recommendationsWithNotes}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="chart-container bg-white p-4 rounded-lg border border-slate-200">
                                <h3 className="text-lg font-semibold text-slate-700 mb-4">Category Distribution</h3>
                                <canvas id="categoryChart"></canvas>
                            </div>
                            <div className="chart-container bg-white p-4 rounded-lg border border-slate-200">
                                <h3 className="text-lg font-semibold text-slate-700 mb-4">Top Resource Tags</h3>
                                <canvas id="resourceChart"></canvas>
                            </div>
                        </div>

                        <div className="mt-6">
                            <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4">Tag Correlations</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full">
                                    <thead>
                                        <tr>
                                            <th className="px-4 py-2">Tag</th>
                                            {Object.keys(calculateTagCorrelations()).map(tag => (
                                                <th key={tag} className="px-4 py-2">{tag}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.entries(calculateTagCorrelations()).map(([tag1, correlations]) => (
                                            <tr key={tag1}>
                                                <td className="px-4 py-2 font-medium">{tag1}</td>
                                                {Object.keys(correlations).map(tag2 => (
                                                    <td key={tag2} className="px-4 py-2 text-center">
                                                        {correlations[tag2]}
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        {/* Word Cloud */}
                        <div className="mt-6">
                            <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4">Common Terms</h3>
                            <div className="word-cloud" id="wordCloud"></div>
                        </div>
                        
                        {/* Network Graph */}
                        <div className="mt-6">
                            <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4">Tag Relationships</h3>
                            <div id="networkGraph" className="w-full h-96"></div>
                        </div>
                        
                        {/* Export Buttons */}
                        <div className="mt-6 flex justify-end space-x-4">
                            <button
                                onClick={exportToPDF}
                                className="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-700 transition-colors"
                            >
                                Export to PDF
                            </button>
                            <button
                                onClick={exportToExcel}
                                className="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-700 transition-colors"
                            >
                                Export to Excel
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Settings Modal */}
            {isSettingsOpen && (
                <div className="modal-overlay">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800">Tag Management</h2>
                            <button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 hover:text-slate-600">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        
                        <div className="space-y-6">
                            {/* Source Tags Management */}
                            <div>
                                <h3 className="text-lg font-semibold text-slate-700 mb-3">Source Tags</h3>
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {allSourceTags.map(tag => (
                                        <div key={tag} className="flex items-center bg-slate-100 rounded-full px-3 py-1">
                                            <span className="text-sm text-slate-700">{tag}</span>
                                            <button
                                                onClick={() => handleDeleteTagFromRepo(tag, 'source')}
                                                className="ml-2 text-slate-400 hover:text-red-600"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <TagInput
                                    existingTags={allSourceTags}
                                    onAddTag={(tag) => handleAddTagToRepo(tag, 'source')}
                                    placeholder="Add new source tag..."
                                    colorClass="focus:ring-slate-500"
                                />
                            </div>

                            {/* Resource Tags Management */}
                            <div>
                                <h3 className="text-lg font-semibold text-slate-700 mb-3">Resource Tags</h3>
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {allResourceTags.map(tag => (
                                        <div key={tag} className="flex items-center bg-slate-100 rounded-full px-3 py-1">
                                            <span className="text-sm text-slate-700">{tag}</span>
                                            <button
                                                onClick={() => handleDeleteTagFromRepo(tag, 'resource')}
                                                className="ml-2 text-slate-400 hover:text-red-600"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <TagInput
                                    existingTags={allResourceTags}
                                    onAddTag={(tag) => handleAddTagToRepo(tag, 'resource')}
                                    placeholder="Add new resource tag..."
                                    colorClass="focus:ring-slate-500"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Delete Confirmation Modal */}
            {confirmDelete && (
                <div className="modal-overlay">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                        <h2 className="text-xl font-bold text-slate-800 mb-4">Confirm Delete</h2>
                        <p className="text-slate-600 mb-6">Are you sure you want to delete this recommendation?</p>
                        <div className="flex justify-end space-x-4">
                            <button
                                onClick={() => setConfirmDelete(null)}
                                className="px-4 py-2 text-slate-600 hover:text-slate-800"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={() => handleDeleteRecommendation(confirmDelete.id)}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Keyboard Shortcuts Modal */}
            {showKeyboardShortcuts && (
                <div className="modal-overlay">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 scale-in">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800">Keyboard Shortcuts</h2>
                            <button
                                onClick={() => setShowKeyboardShortcuts(false)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div className="space-y-4">
                            <div className="flex justify-between items-center">
                                <span className="text-slate-600">Show this menu</span>
                                <kbd className="px-2 py-1 bg-slate-100 rounded text-sm">Ctrl + /</kbd>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-600">Search</span>
                                <kbd className="px-2 py-1 bg-slate-100 rounded text-sm">Ctrl + F</kbd>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-600">New recommendation</span>
                                <kbd className="px-2 py-1 bg-slate-100 rounded text-sm">Ctrl + N</kbd>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-600">Close modal</span>
                                <kbd className="px-2 py-1 bg-slate-100 rounded text-sm">Esc</kbd>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Print View */}
            {showPrintView && (
                <div className="fixed inset-0 bg-white p-8 overflow-auto">
                    <div className="max-w-4xl mx-auto">
                        <h1 className="text-3xl font-bold mb-8">Disability Care Dashboard</h1>
                        
                        <div className="mb-8">
                            <h2 className="text-2xl font-semibold mb-4">Statistics</h2>
                            <div className="grid grid-cols-3 gap-4">
                                <div className="p-4 border rounded">
                                    <h3 className="text-sm font-medium text-slate-500">Total Recommendations</h3>
                                    <p className="text-2xl font-bold">{statsData?.totalRecommendations}</p>
                                </div>
                                <div className="p-4 border rounded">
                                    <h3 className="text-sm font-medium text-slate-500">Average Tags</h3>
                                    <p className="text-2xl font-bold">{statsData?.averageTagsPerRecommendation.toFixed(1)}</p>
                                </div>
                                <div className="p-4 border rounded">
                                    <h3 className="text-sm font-medium text-slate-500">With Notes</h3>
                                    <p className="text-2xl font-bold">{statsData?.recommendationsWithNotes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="space-y-8">
                            {recommendations.map((rec, index) => (
                                <div key={rec.id} className="recommendation-card p-6 border rounded">
                                    <h3 className="text-xl font-semibold mb-4">Recommendation {index + 1}</h3>
                                    <p className="mb-4">{rec.text}</p>
                                    {rec.notes && (
                                        <div className="mb-4">
                                            <h4 className="font-medium mb-2">Notes:</h4>
                                            <p>{rec.notes}</p>
                                        </div>
                                    )}
                                    <div className="flex flex-wrap gap-2">
                                        {(rec.tags || []).map(tag => (
                                            <span key={tag} className="px-2 py-1 bg-slate-100 rounded text-sm">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
            
            {/* Dark mode toggle */}
            <button
                onClick={toggleDarkMode}
                className="fixed bottom-8 right-8 bg-slate-800 text-white p-4 rounded-full shadow-lg hover:bg-slate-700 transition-colors"
                title="Toggle Dark Mode"
            >
                {isDarkMode ? (
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                ) : (
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                    </svg>
                )}
            </button>
            
            {/* Keyboard Shortcuts Legend */}
            <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white dark:bg-slate-800 rounded-lg shadow-lg p-4 no-print">
                <div className="flex space-x-4">
                    <div className="flex items-center">
                        <kbd className="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded">Ctrl+Z</kbd>
                        <span className="ml-2">Undo</span>
                    </div>
                    <div className="flex items-center">
                        <kbd className="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded">Ctrl+Shift+Z</kbd>
                        <span className="ml-2">Redo</span>
                    </div>
                    <div className="flex items-center">
                        <kbd className="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded">Ctrl+D</kbd>
                        <span className="ml-2">Toggle Dark Mode</span>
                    </div>
                    <div className="flex items-center">
                        <kbd className="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded">Ctrl+P</kbd>
                        <span className="ml-2">Print View</span>
                    </div>
                    <div className="flex items-center">
                        <kbd className="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded">Ctrl+S</kbd>
                        <span className="ml-2">Export to Excel</span>
                    </div>
                </div>
            </div>
        </div>
    );
}

// Add error boundary
try {
    ReactDOM.render(<App />, document.getElementById('root'));
} catch (error) {
    console.error('React initialization error:', error);
    document.getElementById('root').innerHTML = `
        <div class="text-center p-12">
            <h1 class="text-2xl font-bold text-red-600 mb-4">Error Loading Application</h1>
            <p class="text-slate-600">There was an error initializing the application. Please check the console for more details.</p>
        </div>
    `;
}
    </script>
</body>
</html>
